package ticket.booking.service;

import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;

import ticket.booking.entities.Ticket;
import ticket.booking.entities.Train;
import ticket.booking.entities.User;
import ticket.booking.util.UserServiceUtil;
import java.io.File;
import java.io.IOException;
import java.util.*;
import java.nio.file.Files;
import java.nio.file.Paths;

public class UserBookingService{
    
    private ObjectMapper objectMapper = new ObjectMapper(); 

    private List<User> userList; // fetched LocalDb file heres 

    private User user;

    public UserBookingService(User user) throws IOException {
        this.user = user;
        loadUserListFromFile();
    }

    public UserBookingService() throws IOException {
        loadUserListFromFile();
    }

    private void loadUserListFromFile() throws IOException {
        String userFilePath = "src/main/java/ticket/booking/localDB/users.json";
        userList = objectMapper.readValue(new File(userFilePath), new TypeReference<List<User>>() {});
    }

    public Boolean loginUser(){
        System.out.println("DEBUG: Trying to login user: '" + user.getName() + "'");
        System.out.println("DEBUG: Password provided: '" + user.getPassword() + "'");
        System.out.println("DEBUG: Users in database: " + userList.size());
        
        for (User dbUser : userList) {
            System.out.println("DEBUG: DB User: '" + dbUser.getName() + "' with hash: " + (dbUser.getHashedPassword().isEmpty() ? "EMPTY" : "HAS_HASH"));
        }
        
        Optional<User> foundUser = userList.stream().filter(user1 -> { // seq onujayi // filer krtese e/O
            boolean nameMatch = user1.getName().equals(user.getName());
            boolean passMatch = UserServiceUtil.checkPassword(user.getPassword(), user1.getHashedPassword());
            System.out.println("DEBUG: User '" + user1.getName() + "' - Name: " + nameMatch + ", Pass: " + passMatch);
            return nameMatch && passMatch;
        }).findFirst();
        return foundUser.isPresent();
    }

    public Boolean signUp(User user1)
    {
        try{
            userList.add(user1);
            saveUserListToFile();
            return Boolean.TRUE;
        }catch (IOException ex){
            return Boolean.FALSE;
        }
    }

    private void saveUserListToFile() throws IOException {
        String userFilePath = "src/main/java/ticket/booking/localDB/users.json";
        File usersFile = new File(userFilePath);
        objectMapper.writeValue(usersFile, userList);
    }

    public void fetchBookings()
    {
        if (user == null) {
            System.out.println("Please login first to fetch bookings.");
        //     return;
        }
      //   
        try {
            // Reload the user data from file to get the//  latest bookings
   //          l// oadUserListFromFile();
            Optal<User> userFhed = userList.stream().filter(user1 -> {
                return user1.geme().equals(user.getName());
         }).findFirst();
            
            if(userFetched.isPresent()){
             List<Ticket> tickets = userFetched.get().getTicketsBook);
                if(tickets == null || kets.isEmpty()){
                    Systout.println("No bookings found.");
                } else {
                 System.out.println("Your bookings:");
                    rFetched.get().printTickets();
                }
            }se {
                Systout.println("User not found.");
            }
        } ca (IOException e) {
            System.out.println("Errloading user data:+ e.getMessage());
     }
    }

        // todo: Complete this function
   blic Boolean celBooking(String ticketId)
    {
     if (user == null) {
            System.out.println("Please login first to cel bookings.");
            return Boolean.FALSE;
        }

        if (ticketId == null || ticketId.isEmpty()) {
            System.out.println("Ticket ID cannot be null or empty.");
            return Boolean.FALSE;
        }

        // Find the ticket to get seat information
        Ticket ticketToCancel = null;
        for (Ticket ticket : user.getTicketsBooked()) {
            if (ticket.getTicketId().equals(ticketId)) {
                ticketToCancel = ticket;
                break;
            }
        }
        
        if (ticketToCancel == null) {
            System.out.println("No ticket found with ID " + ticketId);
            return Boolean.FALSE;
        }
        
        try {
            // Free up the seat in the train
            TrainService trainService = new TrainService();
            Train train = ticketToCancel.getTrain();
            List<List<Integer>> seats = train.getSeats();
            int row = ticketToCancel.getSeatRow();
            int col = ticketToCancel.getSeatColumn();
            
            // Set seat back to available (0)
            seats.get(row).set(col, 0);
            train.setSeats(seats);
            
            // Update train data
            trainService.addTrain(train);
            
            // Remove ticket from user's booking list
            user.getTicketsBooked().removeIf(ticket -> ticket.getTicketId().equals(ticketId));
            
            // Update the user in the userList
            for (int i = 0; i < userList.size(); i++) {
                if (userList.get(i).getName().equals(user.getName())) {
                    userList.set(i, user);
                    break;
                }
            }
            
            // Save updated user data
            saveUserListToFile();
            
            System.out.println("Ticket with ID " + ticketId + " has been canceled.");
            System.out.println("Seat Row " + row + ", Column " + col + " is now available.");
            return Boolean.TRUE;
            
        } catch (IOException ex) {
            System.out.println("Error canceling booking: " + ex.getMessage());
            return Boolean.FALSE;
        }
    }
        

    public List<Train> getTrains(String source, String destination)
    {
        try{
            TrainService trainService = new TrainService();
            return trainService.searchTrains(source, destination);
        }catch(IOException ex){
            return new ArrayList<>();
        }
    }

    public List<List<Integer>> fetchSeats(Train train){
            return train.getSeats();
    }

    public Boolean bookTrainSeat(Train train, int row, int seat, String source, String destination) {
        try{
            if (user == null) {
                System.out.println("Please login first to book seats.");
                return Boolean.FALSE;
            }
            
            TrainService trainService = new TrainService();
            List<List<Integer>> seats = train.getSeats();
            if (row >= 0 && row < seats.size() && seat >= 0 && seat < seats.get(row).size()) 
            {
                if (seats.get(row).get(seat) == 0) 
                {
                    // Mark seat as booked
                    seats.get(row).set(seat, 1);
                    train.setSeats(seats);
                    trainService.addTrain(train);
                    
                    // Create a ticket
                    String ticketId = "TICKET_" + System.currentTimeMillis(); // Generate unique ticket ID
                    Ticket ticket = new Ticket(ticketId, user.getUserId(), 
                                             source, // actual source selected by user
                                             destination, // actual destination selected by user
                                             new java.util.Date().toString(), // date of travel
                                             train, row, seat);
                    
                    // Add ticket to user's booked tickets
                    user.getTicketsBooked().add(ticket);
                    
                    // Update the user in the userList
                    for (int i = 0; i < userList.size(); i++) 
                    {
                        if (userList.get(i).getName().equals(user.getName())) 
                        {
                            userList.set(i, user);
                            break;
                        }
                    }
                    
                    // Update user data in the file
                    saveUserListToFile();
                    
                    System.out.println("Ticket ID: " + ticketId + " (Save this for cancellation)");
                    return true; // Booking successful
                } else {
                    return false; // Seat is already booked
                }
            } else {
                return false; // Invalid row or seat index
            }
        }catch (IOException ex){
            ex.printStackTrace();
            return Boolean.FALSE;
        }
    }
}
